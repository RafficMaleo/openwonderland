<project basedir="." default="..." name="front.package">
    <!-- set the build-scripts directory to the current directory -->
    <dirname property="front.build-scripts.dir" file="${ant.file.front.package}"/>
    
    <!-- import the web setup file -->
    <property name="web.build-scripts.dir" 
              location="${front.build-scripts.dir}/../../../build-tools/build-scripts"/>
    <import file="${web.build-scripts.dir}/web-build.xml"/> 
        
    <!-- the main package target -->
    <target name="package" depends="-setup, -copy-jars, -generate-native-jars, 
                                    -update-jnlp, -sign-jars"/>
                                    
    <target name="-setup">                               
        <!-- create the app dir -->
        <mkdir dir="${front.webstart.dir}"/>
    </target>

    <!-- copy jar files into the build/lib directory -->
    <target name="-copy-jars">
        <pathconvert property="copy.jars">
            <path path="${core-client.classpath}"/>
        </pathconvert>
        <for param="copy.jar" list="${copy.jars}" delimiter="${path.separator}">
            <sequential>
                <copy todir="${front.jar.dir}" file="@{copy.jar}"/>
            </sequential>
        </for>
    </target>
    
    <!-- create native jars -->
    <target name="-generate-native-jars">
        <for list="${ostypes}" param="ostype">
            <sequential>
                <nativejar ostype="@{ostype}"/>
            </sequential>
        </for>
    </target>
    
    <!-- update the app/Wonderland.jnlp with the list of jars -->
    <target name="-update-jnlp">
        <!-- generate a list of jar files to put in the jnlp -->
        <pathconvert property="jnlp.jars" pathsep=",">
            <path>
                <fileset dir="${front.jar.dir}">
                    <include name="*.jar"/>
                </fileset>
            </path>
            <mapper type="flatten"/>
        </pathconvert>
        
        <!-- create a temporary file and store local jar names to it -->
        <delete file="${build.dir}/jnlp.jars"/>
        
        <for param="jar.name" list="${jnlp.jars}">
            <sequential>
                <echo file="${build.dir}/jnlp.jars" append="true"><![CDATA[<jar href="]]>@{jar.name}<![CDATA["/>]]>
    </echo>
            </sequential>
        </for>
      
        <!-- read the local jar files into a property -->
        <loadfile property="local.jars" srcfile="${build.dir}/jnlp.jars"/>
        
        <!-- update the source .jnlp file with the substituted values -->
        <replace file="${front.webstart.dir}/Wonderland.jnlp">
            <replacefilter token="%LOCAL_JAR_FILES%" value="${local.jars}"/>
        </replace>
      
        <!-- set the main property -->
        <replace file="${front.webstart.dir}/Wonderland.jnlp">
            <replacetoken><![CDATA[<jar href="wonderland-client.jar"/>]]></replacetoken>
            <replacevalue><![CDATA[<jar href="wonderland-client.jar" main="true"/>]]></replacevalue>
        </replace>
    </target>
    
    
    <target name="-sign-jars" depends="-sign-common-jars, -sign-native-jars"/>
    
    <!-- sign and pack200 all jars in the app directory --> 
    <target name="-sign-common-jars">
        <pathconvert property="common.jars" pathsep=",">
            <fileset dir="${front.jar.dir}">
                <include name="*.jar"/>
            </fileset>
            <mapper type="flatten"/>
        </pathconvert>
        
        <for param="sign.jar.name" list="${common.jars}">
            <sequential>
                <signjarnopack src.jar="${front.jar.dir}/@{sign.jar.name}"
                               dest.jar="${front.webstart.dir}/@{sign.jar.name}"/>
            </sequential>
        </for>
    </target>
    
    <!-- sign all jars in the native directories --> 
    <target name="-sign-native-jars">
        <for list="${ostypes}" param="ostype">
            <sequential>
                <if>
                    <available file="${front.jar.dir}/@{ostype}/wonderland_native.jar"/>
                    <then>
                        <mkdir dir="${front.webstart.dir}/@{ostype}"/>
                        <signjarnopack src.jar="${front.jar.dir}/@{ostype}/wonderland_native.jar"
                                       dest.jar="${front.webstart.dir}/@{ostype}/wonderland_native.jar"/>
                    </then>
                </if>
            </sequential>
        </for>
    </target>
    
    <!-- macro for making native jars -->
    <macrodef name="nativejar">
        <attribute name="ostype"/>
        
        <sequential>
            <ant antfile="${core.build-scripts.dir}/core-setup.xml" 
                 target="unpack-core-libs"
                 inheritall="false">
                     <property name="ostype" value="@{ostype}"/>
            </ant>
            <if>
                <available file="${core.lib.dir}/@{ostype}/native"/>
                <then>
                    <mkdir dir="${front.jar.dir}/@{ostype}"/>
                    <jar jarfile="${front.jar.dir}/@{ostype}/wonderland_native.jar">
                        <fileset dir="${core.lib.dir}/@{ostype}/native"/>
                    </jar>
                </then>
            </if>
        </sequential>
    </macrodef>
    
    <!-- macro for signing and pack200ing jars -->
    <macrodef name="signandpackjar">
        <attribute name="src.jar"/>
        <attribute name="dest.jar"/>
        
        <sequential>
            <if>
                <not>
                    <uptodate targetfile="@{dest.jar}.pack.gz"
                              srcfile="@{src.jar}"/>
                </not>
                <then>
                    <pack200 src="@{src.jar}"
                             destfile="@{dest.jar}.repack.jar"
                             repack="true"
                             segmentlimit="-1"/>
                    <signjar jar="@{dest.jar}.repack.jar"
                             keystore="${wonderland.keystore}"
                             alias="${wonderland.keystore.alias}"
                             storepass="${wonderland.keystore.password}"
                             signedjar="@{dest.jar}.repack.sign.jar"/>
                    <pack200 src="@{dest.jar}.repack.sign.jar"
                             gzipoutput="true"
                             destfile="@{dest.jar}.pack.gz"
                             segmentlimit="-1"/>
                                 
                    <!-- copy over the original jar with the signed version.
                         Force an overwrite, since ant will sometimes decide
                         the files are the same age if the packing happens
                         quickly -->
                    <copy file="@{dest.jar}.repack.sign.jar"
                          tofile="@{dest.jar}"
                          overwrite="true"/>
                        
                    <!-- remove intermediate files -->
                    <delete file="@{dest.jar}.repack.jar"/>
                    <delete file="@{dest.jar}.repack.sign.jar"/>
                </then>
            </if>
        </sequential>
    </macrodef>
    
    <!-- macro for signing jars without pack200 -->
    <macrodef name="signjarnopack">
        <attribute name="src.jar"/>
        <attribute name="dest.jar"/>
        
        <sequential>
            <signjar jar="@{src.jar}"
                     keystore="${wonderland.keystore}"
                     alias="${wonderland.keystore.alias}"
                     storepass="${wonderland.keystore.password}"
                     signedjar="@{dest.jar}"/>        
        </sequential>
    </macrodef>
</project>
